<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ELYRA — Login</title>
  <link rel="stylesheet" href="./assets/competitions.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topbar">
    <div class="container row">
      <div class="brand">ELYRA</div>
      <div class="navlinks">
        <a href="/competitions/">Competitions</a>
        <a href="/competitions/organizer/">Organizer</a>
        <a href="/">Home</a>
      </div>
    </div>
  </div>

  <div class="container hero">
    <h1 class="h1">Login</h1>
    <p class="p">Enter your email. We’ll send you a secure sign-in link from Elyra.</p>
  </div>

  <div class="container">
    <div class="card">
      <div class="label">Email</div>
      <input class="input" id="email" type="email" placeholder="you@example.com" autocomplete="email"/>

      <div style="height:12px"></div>
      <button class="btn primary" id="sendBtn" type="button">Send sign-in link</button>

      <div class="hr"></div>
      <p class="small" id="msg"></p>

      <p class="small" style="margin-top:10px;opacity:.85">
        Tip: If you don’t see the email within 1–2 minutes, check Spam / Promotions.
      </p>
    </div>
  </div>

  <script type="module">
    import { sendMagicLink, getSession } from "./assets/auth.js";
    import { setText, getParam } from "./assets/ui.js";

    const email = document.getElementById("email");
    const sendBtn = document.getElementById("sendBtn");
    const msg = document.getElementById("msg");

    // Cooldown to avoid email rate-limit while testing
    const COOLDOWN_MS = 90_000; // 90 seconds is safer than 60s
    const KEY = "elyra_login_cooldown_until";

    function toSafePath(input){
      // Allow only same-site relative paths.
      if(!input) return "/competitions/";

      try{
        const decoded = decodeURIComponent(input);

        // If someone passed a full URL, keep only its pathname+search
        if(decoded.startsWith("http://") || decoded.startsWith("https://")){
          const u = new URL(decoded);
          return (u.pathname + u.search).startsWith("/") ? (u.pathname + u.search) : "/competitions/";
        }

        // Normal expected case: "/competitions/contestant.html?...":
        return decoded.startsWith("/") ? decoded : "/competitions/";
      }catch{
        return "/competitions/";
      }
    }

    function safeNextFromUrl(){
      return toSafePath(getParam("next"));
    }

    function setCooldown(seconds = COOLDOWN_MS / 1000){
      localStorage.setItem(KEY, String(Date.now() + (seconds * 1000)));
      updateCooldownUI();
    }

    function updateCooldownUI(){
      const untilStr = localStorage.getItem(KEY);
      const until = untilStr ? Number(untilStr) : 0;
      const left = Math.max(0, until - Date.now());

      if(left > 0){
        const secs = Math.ceil(left / 1000);
        sendBtn.disabled = true;
        setText(msg, `Link sent ✅ Please wait ${secs}s before requesting another.`);
        setTimeout(updateCooldownUI, 500);
      }else{
        sendBtn.disabled = false;
        if((msg.textContent || "").toLowerCase().includes("please wait")){
          setText(msg, "");
        }
      }
    }

    // If already logged in, send them back where they intended
    (async () => {
      try{
        const session = await getSession();
        if(session){
          location.replace(safeNextFromUrl());
        }
      }catch{
        // ignore
      }
    })();

    async function submit(){
      try{
        // Block if still cooling down
        const untilStr = localStorage.getItem(KEY);
        const until = untilStr ? Number(untilStr) : 0;
        if(until && until > Date.now()){
          updateCooldownUI();
          return;
        }

        const v = (email.value || "").trim();
        if(!v) throw new Error("Please enter your email.");
        if(!v.includes("@") || !v.includes(".")) throw new Error("Please enter a valid email address.");

        const nextSafe = safeNextFromUrl();

        sendBtn.disabled = true;
        setText(msg, "Sending your sign-in link…");

        await sendMagicLink(v, nextSafe);

        setText(msg, "Success ✅ Check your email for your Elyra sign-in link.");
        setCooldown();
      }catch(e){
        console.error(e);
        const m = String(e?.message || "").toLowerCase();

        // Rate limit message handling
        if(m.includes("rate") && m.includes("limit")){
          setText(msg, "Too many requests. Please wait a few minutes, then try again.");
          // Longer cooldown when rate limited
          setCooldown(180); // 3 minutes
          return;
        }

        setText(msg, e?.message || "Failed to send link.");
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", submit);
    email.addEventListener("keydown", (e) => { if(e.key === "Enter") submit(); });

    updateCooldownUI();
  </script>
</body>
</html>
