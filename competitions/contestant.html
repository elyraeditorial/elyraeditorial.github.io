<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Elyra — Contestant</title>
  <link rel="stylesheet" href="./assets/competitions.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topbar">
    <div class="container row">
      <div class="brand">ELYRA</div>
      <div class="navlinks">
        <a href="/competitions/">Competitions</a>
        <a href="/competitions/login.html" id="loginLink">Login</a>
        <a href="/">Home</a>
        <button class="btn" id="logoutBtn" style="display:none">Log out</button>
      </div>
    </div>
  </div>

  <div class="container hero">
    <h1 class="h1" id="name">Loading…</h1>
    <p class="p" id="bio"></p>

    <!-- Payment / status banner -->
    <div class="notice" id="notice" style="display:none;"></div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card span12">
        <div class="kpi">
          <div class="box" id="voteNote">Free vote: 1 per person</div>
          <div class="box" id="loginState">Checking login…</div>
        </div>

        <div class="hr"></div>

        <div class="btnrow">
          <button class="btn primary btn3d" id="voteBtn">Vote (Free)</button>
          <a class="btn" id="backBtn" href="/competitions/">Back</a>
        </div>

        <div class="hr"></div>

        <div class="payBox">
          <div class="label">Want to support more?</div>
          <div class="small">Paid votes are optional. You’ll return to Elyra after checkout.</div>
          <div style="height:10px"></div>

          <div class="btnrow">
            <a class="btn btn3d glow10" id="pay10" target="_blank" rel="noopener">Buy Votes ($10)</a>
            <a class="btn btn3d glow50" id="pay50" target="_blank" rel="noopener">Buy Votes ($50)</a>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small" id="msg"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { fetchContestantById, fetchContestBySlug } from "./assets/data.js";
    import { castFreeVote } from "./assets/vote.js";
    import { getSession, signOut } from "./assets/auth.js";
    import { getParam, setText, toast } from "./assets/ui.js";

    // ✅ Your Stripe payment links:
    const STRIPE_10 = "https://buy.stripe.com/9B6aEQd5F5YR9uI7oC4sE09";
    const STRIPE_50 = "https://buy.stripe.com/28EbIU2r1fzr36k38m4sE0b";

    const id = getParam("id");
    const slug = getParam("slug");

    const name = document.getElementById("name");
    const bio = document.getElementById("bio");
    const msg = document.getElementById("msg");
    const notice = document.getElementById("notice");

    const voteBtn = document.getElementById("voteBtn");
    const loginState = document.getElementById("loginState");
    const backBtn = document.getElementById("backBtn");

    const pay10 = document.getElementById("pay10");
    const pay50 = document.getElementById("pay50");

    const loginLink = document.getElementById("loginLink");
    const logoutBtn = document.getElementById("logoutBtn");

    // ✅ Keep back button pointing to the right contest
    if(slug) backBtn.href = `/competitions/contest.html?slug=${encodeURIComponent(slug)}`;

    // ✅ Stripe buttons (redirect configured inside Stripe settings)
    pay10.href = STRIPE_10;
    pay50.href = STRIPE_50;

    // ✅ Payment banner messages (supports ?paid=success / ?paid=cancel / ?paid=1)
    const paid = getParam("paid");
    if (paid === "success" || paid === "1") {
      notice.style.display = "block";
      notice.textContent = "Payment received ✅ Thank you for supporting Elyra.";
    } else if (paid === "cancel") {
      notice.style.display = "block";
      notice.textContent = "Payment cancelled. You can still cast your free vote anytime.";
    }

    // ✅ Login / logout toggle
    try{
      const session = await getSession();

      if(session){
        if(loginLink) loginLink.style.display = "none";
        if(logoutBtn) logoutBtn.style.display = "inline-flex";

        logoutBtn?.addEventListener("click", async () => {
          await signOut();
          location.href = "/competitions/login.html";
        });
      }else{
        // Preserve return path so user comes back here after login
        const nextUrl = `${location.pathname}${location.search}`;
        if(loginLink) loginLink.href = `/competitions/login.html?next=${encodeURIComponent(nextUrl)}`;

        if(logoutBtn) logoutBtn.style.display = "none";
      }
    }catch(e){
      console.warn("Session check failed:", e);
    }

    let contestId = null;

    try{
      const contestant = await fetchContestantById(id);
      if(!contestant) throw new Error("Contestant not found.");

      setText(name, contestant.display_name || "Contestant");
      setText(bio, contestant.bio || "");

      // Resolve contest_id
      if(slug){
        const contest = await fetchContestBySlug(slug);
        contestId = contest?.id || contestant.contest_id;
      }else{
        contestId = contestant.contest_id;
      }

      const session = await getSession();
      const loggedIn = !!session;

      setText(loginState, loggedIn ? "Logged in ✅" : "Log in to cast your free vote");

      // ✅ Disable free vote button if not logged in
      if(!loggedIn){
        voteBtn.disabled = true;
        setText(msg, "Please log in to cast your free vote.");
      }

      voteBtn.addEventListener("click", async () => {
        try{
          voteBtn.disabled = true;
          setText(msg, "Submitting vote…");
          await castFreeVote(contestId, contestant.id);
          toast("Vote submitted ✅");
          setText(msg, "Vote submitted. Thank you for supporting!");
        }catch(err){
          console.error(err);
          toast(err?.message || "Vote failed.");
          setText(msg, err?.message || "Vote failed.");
        }finally{
          voteBtn.disabled = false;
        }
      });

    }catch(err){
      console.error(err);
      setText(name, "Error");
      setText(bio, err?.message || "Unknown error");
      voteBtn.disabled = true;
    }
  </script>

  <!-- Banner style (inline so it works even if CSS isn't updated yet) -->
  <style>
    .notice{
      margin-top:14px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(242,242,242,.85);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
  </style>
</body>
</html>
