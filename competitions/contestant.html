<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Elyra — Contestant</title>
  <link rel="stylesheet" href="./assets/competitions.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topbar">
    <div class="container row">
      <div class="brand">ELYRA</div>
      <div class="navlinks">
        <a href="/competitions/">Competitions</a>
        <a id="navLoginLink" href="/competitions/login.html">Login</a>
        <a id="navSignOutLink" href="#" style="display:none;">Sign out</a>
        <a href="/">Home</a>
        <span id="navWho" class="navwho"></span>
      </div>
    </div>
  </div>

  <div class="container hero">
    <h1 class="h1" id="name">Loading…</h1>
    <p class="p" id="bio"></p>

    <div class="card" id="photoCard" style="display:none; padding:12px; margin-top:14px;">
      <img id="photoImg" alt="Contestant photo"
           style="width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.10);" loading="lazy"/>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card span12">
        <div class="kpi">
          <div class="box" id="voteNote">Free vote: 1 per person</div>
          <div class="box" id="loginState">Checking login…</div>
          <div class="box" id="totalVotes">Total votes: —</div>
        </div>

        <div class="hr"></div>

        <div class="btnrow">
          <button class="btn primary btn3d" id="voteBtn" type="button">Vote (Free)</button>
          <a class="btn" id="backBtn" href="/competitions/">Back</a>
        </div>

        <div class="hr"></div>

        <div class="payBox">
          <div class="label">Want to support more?</div>
          <div class="small">Paid votes are optional. You’ll return to Elyra after checkout.</div>
          <div style="height:10px"></div>

          <div class="btnrow">
            <a class="btn btn3d glow10" id="pay10" href="#">Buy Votes ($10)</a>
            <a class="btn btn3d glow50" id="pay50" href="#">Buy Votes ($50)</a>
          </div>

          <p class="small" id="voteBreakdown" style="margin-top:10px; opacity:.9"></p>
        </div>

        <div class="hr"></div>
        <p class="small" id="msg"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import * as dataApi from "./assets/data.js";

    // ✅ CACHE-BUST vote.js so Safari/Cloudflare doesn't keep the old one
    import { castFreeVote, startPaidVoteCheckout } from "./assets/vote.js?v=3";

    import { getSession } from "./assets/auth.js";
    import { getParam, setText, toast } from "./assets/ui.js";
    import { wireNavAuth } from "./assets/navAuth.js";

    wireNavAuth();

    const id = getParam("id");
    const slug = getParam("slug");

    const name = document.getElementById("name");
    const bio = document.getElementById("bio");
    const msg = document.getElementById("msg");
    const voteBtn = document.getElementById("voteBtn");
    const loginState = document.getElementById("loginState");
    const totalVotes = document.getElementById("totalVotes");
    const voteBreakdown = document.getElementById("voteBreakdown");
    const backBtn = document.getElementById("backBtn");

    const pay10 = document.getElementById("pay10");
    const pay50 = document.getElementById("pay50");

    const photoCard = document.getElementById("photoCard");
    const photoImg  = document.getElementById("photoImg");

    if (slug) backBtn.href = `/competitions/contest.html?slug=${encodeURIComponent(slug)}`;

    function safeImg(url){
      if(!url) return null;
      const u = String(url).trim();
      if(u.startsWith("http://") || u.startsWith("https://")) return u;
      return null;
    }

    function currentPathWithQuery(){
      return location.origin + location.pathname + location.search;
    }

    function goLoginReturnHere(){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `/competitions/login.html?next=${next}`;
    }

    async function refreshTotals(contestantId){
      try{
        if(typeof dataApi.fetchVoteTotalsForContestant !== "function"){
          setText(totalVotes, "Total votes: —");
          setText(voteBreakdown, "");
          return;
        }

        const t = await dataApi.fetchVoteTotalsForContestant(contestantId);
        const total = (t?.total_votes ?? t?.total ?? 0);
        const free  = (t?.free_votes  ?? t?.free  ?? null);
        const paid  = (t?.paid_votes  ?? t?.paid  ?? null);

        setText(totalVotes, `Total votes: ${Number(total || 0).toLocaleString()}`);

        if(free !== null || paid !== null){
          setText(
            voteBreakdown,
            `Breakdown: Free ${Number(free || 0).toLocaleString()} · Paid ${Number(paid || 0).toLocaleString()}`
          );
        } else {
          setText(voteBreakdown, "");
        }
      }catch(e){
        console.error(e);
        setText(totalVotes, "Total votes: —");
        setText(voteBreakdown, "");
      }
    }

    let contestId = null;
    let contestantId = null;

    if(getParam("paid") === "1"){
      setText(msg, "Payment received ✅ Thank you for supporting Elyra.");
    }

    try{
      if(!id) throw new Error("Missing contestant id.");

      const contestant = await dataApi.fetchContestantById(id);
      if(!contestant) throw new Error("Contestant not found.");

      contestantId = contestant.id;

      setText(name, contestant.display_name || "Contestant");
      setText(bio, contestant.bio || "");

      const p = safeImg(contestant.photo_url);
      if(p){
        photoImg.src = p;
        photoCard.style.display = "block";
      }else{
        photoCard.style.display = "none";
      }

      if(slug){
        const contest = await dataApi.fetchContestBySlug(slug);
        contestId = contest?.id || contestant.contest_id;
      }else{
        contestId = contestant.contest_id;
      }

      const session = await getSession();
      setText(loginState, session ? "Logged in ✅" : "Not logged in — free vote requires login");
      voteBtn.disabled = false;

      await refreshTotals(contestantId);

      voteBtn.addEventListener("click", async () => {
        try{
          const s = await getSession();
          if(!s){
            toast("Please log in to cast your free vote.");
            goLoginReturnHere();
            return;
          }

          voteBtn.disabled = true;
          setText(msg, "Submitting vote…");
          await castFreeVote(contestId, contestantId);
          toast("Vote submitted ✅");
          setText(msg, "Vote submitted. Thank you!");
          await refreshTotals(contestantId);

        }catch(err){
          console.error(err);
          toast(err?.message || "Vote failed.");
          setText(msg, err?.message || "Vote failed.");
        }finally{
          voteBtn.disabled = false;
        }
      });

      pay10.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await startPaidVoteCheckout({
            contestId,
            contestantId,
            pack: 10,
            returnTo: currentPathWithQuery()
          });
        } catch (err) {
          console.error(err);
          toast(err?.message || "Checkout failed.");
        }
      });

      pay50.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          await startPaidVoteCheckout({
            contestId,
            contestantId,
            pack: 50,
            returnTo: currentPathWithQuery()
          });
        } catch (err) {
          console.error(err);
          toast(err?.message || "Checkout failed.");
        }
      });

    }catch(err){
      console.error(err);
      setText(name, "Error");
      setText(bio, err?.message || "Unknown error");
      voteBtn.disabled = true;
      photoCard.style.display = "none";
      setText(totalVotes, "Total votes: —");
      setText(voteBreakdown, "");
    }
  </script>
</body>
</html>
