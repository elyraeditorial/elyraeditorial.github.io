<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Elyra — Contestant</title>
  <link rel="stylesheet" href="./assets/competitions.css"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="topbar">
    <div class="container row">
      <div class="brand">ELYRA</div>
      <div class="navlinks">
        <a href="/competitions/">Competitions</a>
        <a href="/competitions/login.html">Login</a>
        <a href="/">Home</a>
      </div>
    </div>
  </div>

  <div class="container hero">
    <h1 class="h1" id="name">Loading…</h1>
    <p class="p" id="bio"></p>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card span12">
        <div class="kpi">
          <div class="box" id="voteNote">Free vote: 1 per person</div>
          <div class="box" id="loginState">Checking login…</div>
        </div>

        <div class="hr"></div>

        <!-- FREE VOTE -->
        <div class="btnrow">
          <button class="btn primary" id="voteBtn">Vote (Free)</button>
          <a class="btn" id="backBtn" href="/competitions/">Back</a>
        </div>

        <!-- PAID VOTES (Stripe links) -->
        <div class="votingPacks" style="margin-top:14px">
          <div class="vpTitle">Boost with Paid Votes</div>
          <div class="vpSub">
            Paid votes are optional. After checkout, you’ll be redirected back here and see a confirmation message.
          </div>

          <div class="vpBtns">
            <!-- Adjustable $10 -->
            <a class="btn3d buy10"
               id="buy10"
               href="https://buy.stripe.com/9B6aEQd5F5YR9uI7oC4sE09"
               target="_blank"
               rel="noopener noreferrer">
              $10 • Vote Pack
            </a>

            <!-- Adjustable $50 -->
            <a class="btn3d buy50"
               id="buy50"
               href="https://buy.stripe.com/28EbIU2r1fzr36k38m4sE0b"
               target="_blank"
               rel="noopener noreferrer">
              $50 • Vote Pack
            </a>

            <!-- Optional: quick info button (doesn't go anywhere) -->
            <button class="btn3d free" id="howItWorksBtn" type="button">
              How it works
            </button>
          </div>

          <div class="vpStatus" id="paidStatus"></div>
          <div class="vpHint">
            Tip: If Stripe is sending people to the wrong place after payment, set Stripe’s success/cancel redirect to:
            <span class="code">/competitions/contestant.html?paid=1</span>
          </div>
        </div>

        <div class="hr"></div>
        <p class="small" id="msg"></p>
      </div>
    </div>
  </div>

  <script type="module">
    import { fetchContestantById, fetchContestBySlug } from "./assets/data.js";
    import { castFreeVote } from "./assets/vote.js";
    import { getSession } from "./assets/auth.js";
    import { getParam, setText, toast } from "./assets/ui.js";

    const id = getParam("id");
    const slug = getParam("slug");

    const name = document.getElementById("name");
    const bio = document.getElementById("bio");
    const msg = document.getElementById("msg");
    const voteBtn = document.getElementById("voteBtn");
    const loginState = document.getElementById("loginState");
    const backBtn = document.getElementById("backBtn");

    const paidStatus = document.getElementById("paidStatus");
    const howItWorksBtn = document.getElementById("howItWorksBtn");

    if (slug) backBtn.href = `/competitions/contest.html?slug=${encodeURIComponent(slug)}`;

    // 1) If Stripe redirected them back with a flag, show confirmation
    // (This is a "soft" confirmation unless you add webhooks later.)
    const paid = getParam("paid");
    if (paid === "1" || paid === "true" || paid === "success") {
      paidStatus.classList.add("show");
      paidStatus.textContent = "Payment received ✅ Your paid votes will be counted. Thank you!";
    }

    howItWorksBtn?.addEventListener("click", () => {
      paidStatus.classList.add("show");
      paidStatus.textContent =
        "Free vote = 1 per account per contestant. Paid votes are optional via Stripe. After checkout, return here to confirm.";
      setTimeout(() => paidStatus.classList.remove("show"), 6500);
    });

    let contestId = null;

    try {
      const contestant = await fetchContestantById(id);
      if (!contestant) throw new Error("Contestant not found.");

      setText(name, contestant.display_name || "Contestant");
      setText(bio, contestant.bio || "");

      // Resolve contest from slug (so we know contest_id)
      if (slug) {
        const contest = await fetchContestBySlug(slug);
        contestId = contest?.id || contestant.contest_id;
      } else {
        contestId = contestant.contest_id;
      }

      const session = await getSession();
      const isLoggedIn = !!session;
      setText(loginState, isLoggedIn ? "Logged in ✅" : "Not logged in (free vote requires login)");

      if (!isLoggedIn) {
        voteBtn.disabled = true;
        setText(msg, "Please log in to cast your free vote.");
        // Optional: auto-append return path to your login page if your login supports it
        // (Safe even if ignored)
        const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
        const loginLink = document.querySelector('.navlinks a[href="/competitions/login.html"]');
        if (loginLink) loginLink.href = `/competitions/login.html?return=${returnUrl}`;
      }

      voteBtn.addEventListener("click", async () => {
        try {
          voteBtn.disabled = true;
          setText(msg, "Submitting vote…");

          await castFreeVote(contestId, contestant.id);

          toast("Vote submitted ✅");

          // Redirect to confirmation page after free vote
          const to = `/competitions/thanks.html?type=free&name=${encodeURIComponent(contestant.display_name || "Contestant")}` +
                     (slug ? `&slug=${encodeURIComponent(slug)}` : "");
          window.location.href = to;
        } catch (err) {
          console.error(err);
          toast(err?.message || "Vote failed.");
          setText(msg, err?.message || "Vote failed.");
        } finally {
          voteBtn.disabled = false;
        }
      });

    } catch (err) {
      console.error(err);
      setText(name, "Error");
      setText(bio, err?.message || "Unknown error");
      voteBtn.disabled = true;
    }
  </script>
</body>
</html>
